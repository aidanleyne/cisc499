<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>CISC 499</title>
        <style>
          #inputField {
            width: 250px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-family: Arial, sans-serif;
            font-size: 16px;
            color: #333;
            background-color: #f8f8f8;
            transition: border-color 0.3s ease;
          }
          p, #eventsLeftText {
            font-family: Georgia, sans-serif;
            font-size: 16px;
            line-height: 1.6;
            color: #333;
            margin-bottom: 15px;
            text-align: center;
          }
        </style>
    </head>
    
    <body>
        <form style="text-align: center;">
          <label for="inputField" id="eventsLeftText">Type something: (300 events)</label><br>
          <input type="text" id="inputField" name="inputField">
        </form>
        
        <p>Keydown Time: <span id="keydownTime"></span></p>
        <p>Keyup Time: <span id="keyupTime"></span></p>
        
        <div style="display: flex; justify-content: center; align-items: center;">
          <canvas id="myCanvas" width="600" height="481"></canvas>
        </div>
        <script>
        var typingData = {
          RELEASE_TIME : [],
          PRESS_TIME : []
        };
        var eventLength = 0;
        var image_generated = false;
        var keyDown;

        //generates the phase image to display to the user
        function generateImage() {
          //send the events as a JSON to the flask to be generated on the backend
          var xhr = new XMLHttpRequest();
          xhr.open("POST", "/get_events", true);
          xhr.setRequestHeader('Content-Type', 'application/json');
          xhr.send(JSON.stringify(typingData));
          image_generated = true;

          setTimeout(() => {
            console.log("Generating Image...")
          }, 500);

          // Assuming '/get_image' is the Flask route that sends the base64-encoded image
          fetch('/get_image')
            .then(response => response.json()) // Assuming the response is JSON with a base64-encoded image
            .then(data => {
              const image = new Image();
              // Assuming 'data.image' contains the base64-encoded string
              image.src = 'data:image/png;base64,' + data.image;
              image.onload = function() {
                const canvas = document.getElementById('myCanvas');
                const context = canvas.getContext('2d');
                // Draw the image onto the canvas once it's loaded
                context.drawImage(image, 0, 0);
              };
            })
            .catch(error => console.error('Error fetching the image:', error));
          
            askUserStatus();
        }

        // Function to ask the user if they are new or returning
        function askUserStatus() {
          const userStatus = window.prompt('Are you a new or returning user? Type "new" or "returning".');
          
          if (userStatus === 'new') {
            askForUserID();
          } else if (userStatus === 'returning') {
            lookupUser();
          } else {
            console.error('Invalid input. Please type "new" or "returning".');
          }
        }

        // Function to ask for User ID for new users
        function askForUserID() {
          const userID = window.prompt('Please enter your ID:');
          addUser(userID);
        }

        // Function to add a new user
        function addUser(userID) {
          fetch('/add_user', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ id: userID }),
          })
          .then(response => response.json())
          .then(data => {
            if (data.status === 'exists') {
              window.alert('This ID already exists. Please try another ID.');
              askForUserID();
            } else if (data.status === 'added') {
              window.alert('You have been successfully added.');
            }
          })
          .catch(error => console.error('Error adding the user:', error));
        }

        // Function to lookup returning user
        function lookupUser() {
          fetch('/lookup')
            .then(response => response.json())
            .then(data => {
              window.alert('Your user ID is: ' + data.user);
            })
            .catch(error => console.error('Error looking up the user:', error));
        }
        
        //adds all keydown strokes to the events array
        document.getElementById('inputField').addEventListener('keydown', function(event) {
          var time = new Date().getTime();
          document.getElementById('keydownTime').textContent = time;
          keyDown = time;
          /*
          if(image_generated == false){
            typingData.PRESS_TIME.push(time);
            length++;
            if(length >= 300) {
              generateImage();
            } else {
              document.getElementById("eventsLeftText").innerHTML = `Type something: (600 events, ${600-length} left)`
              console.log(length);
            }
          } else {
            document.getElementById("eventsLeftText").innerHTML = "image generated"
          }
          */
        });
        
        //adds all keyup strokes to the events array
        document.getElementById('inputField').addEventListener('keyup', function(event) {
          var time = new Date().getTime();
          document.getElementById('keyupTime').textContent = time;
          if(image_generated == false){
            typingData.RELEASE_TIME.push(time);
            typingData.PRESS_TIME.push(keyDown);
            eventLength++;
            if(eventLength == 300) {
              generateImage();
            } else {
              document.getElementById("eventsLeftText").innerHTML = `Type something: (300 events, ${300-eventLength} left)`
              //console.log(time, keyDown);
            }
          } else {
            document.getElementById("eventsLeftText").innerHTML = "image generated"
          }
        });
        </script>
    </body>
</html>